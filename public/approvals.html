<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Approval Tracker — WhatsApp Command Center</title>
  <style>
    :root {
      --bg-primary: #0a0f1c;
      --bg-card: #141b2d;
      --bg-card-hover: #1a2340;
      --border: #1e2a40;
      --text-primary: #e1e8f0;
      --text-secondary: #8892a4;
      --text-muted: #4a5568;
      --accent: #25D366;
      --accent-dim: rgba(37, 211, 102, 0.1);
      --danger: #e74c3c;
      --danger-dim: rgba(231, 76, 60, 0.1);
      --warning: #f0b429;
      --warning-dim: rgba(240, 180, 41, 0.1);
      --info: #3498db;
      --info-dim: rgba(52, 152, 219, 0.1);
      --purple: #9b59b6;
      --purple-dim: rgba(155, 89, 182, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
    }

    /* ── Sidebar ── */
    .sidebar {
      width: 220px;
      min-height: 100vh;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0; top: 0; bottom: 0;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-size: 1rem;
      font-weight: 700;
      background: linear-gradient(135deg, #25D366, #128C7E);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .sidebar-header .version {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .sidebar-nav { flex: 1; padding: 12px 8px; }

    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 8px; cursor: pointer;
      font-size: 0.85rem; color: var(--text-secondary);
      transition: all 0.15s; margin-bottom: 2px;
      border: none; background: none; width: 100%; text-align: left;
      text-decoration: none;
    }

    .nav-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-dim); color: var(--accent); }
    .nav-icon { font-size: 1.1rem; width: 22px; text-align: center; }

    /* ── Main Content ── */
    .main { margin-left: 220px; flex: 1; padding: 24px 32px; min-height: 100vh; }

    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
    }

    .page-header h2 {
      font-size: 1.5rem; font-weight: 700;
      display: flex; align-items: center; gap: 10px;
    }

    .header-actions { display: flex; gap: 8px; align-items: center; }

    /* ── Stat Cards ── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px; margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex; flex-direction: column; gap: 4px;
    }

    .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.8rem; font-weight: 700; }
    .stat-value.green { color: var(--accent); }
    .stat-value.red { color: var(--danger); }
    .stat-value.yellow { color: var(--warning); }
    .stat-value.blue { color: var(--info); }
    .stat-value.purple { color: var(--purple); }

    /* ── Filters ── */
    .filters-bar {
      display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;
    }

    .filter-btn {
      padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-secondary);
      font-size: 0.8rem; cursor: pointer; transition: all 0.15s;
    }

    .filter-btn:hover { border-color: var(--accent); color: var(--text-primary); }
    .filter-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    .search-input {
      padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-primary);
      font-size: 0.8rem; outline: none; width: 220px;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--text-muted); }

    /* ── Button ── */
    .btn {
      padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-primary);
      font-size: 0.8rem; cursor: pointer; transition: all 0.15s;
      display: inline-flex; align-items: center; gap: 6px;
      text-decoration: none;
    }
    .btn:hover { border-color: var(--accent); background: var(--bg-card-hover); }
    .btn-accent { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
    .btn-accent:hover { background: #20c05a; }

    /* ── Approval Table ── */
    .approvals-table-wrapper {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .approvals-table {
      width: 100%;
      border-collapse: collapse;
    }

    .approvals-table thead th {
      text-align: left;
      padding: 12px 16px;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      position: sticky;
      top: 0;
      background: var(--bg-card);
    }

    .approvals-table tbody tr {
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
    }

    .approvals-table tbody tr:hover { background: var(--bg-card-hover); }
    .approvals-table tbody tr:last-child { border-bottom: none; }

    .approvals-table td {
      padding: 12px 16px;
      font-size: 0.85rem;
      vertical-align: middle;
    }

    /* ── Status Badge ── */
    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 12px;
      font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
    }
    .status-approved { background: var(--accent-dim); color: var(--accent); }
    .status-rejected { background: var(--danger-dim); color: var(--danger); }
    .status-conditional { background: var(--warning-dim); color: var(--warning); }
    .status-pending_review { background: var(--purple-dim); color: var(--purple); }

    .status-dot {
      width: 6px; height: 6px; border-radius: 50%;
    }
    .status-approved .status-dot { background: var(--accent); }
    .status-rejected .status-dot { background: var(--danger); }
    .status-conditional .status-dot { background: var(--warning); }
    .status-pending_review .status-dot { background: var(--purple); }

    .confidence-bar {
      width: 50px; height: 4px; background: var(--border); border-radius: 2px;
      overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 6px;
    }
    .confidence-fill {
      height: 100%; border-radius: 2px;
      transition: width 0.3s;
    }

    .reviewed-check { color: var(--accent); }
    .not-reviewed { color: var(--text-muted); }

    .sender-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #128C7E);
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; color: #fff;
      margin-right: 8px; flex-shrink: 0;
    }

    .sender-cell { display: flex; align-items: center; }

    .msg-preview {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .date-cell {
      white-space: nowrap;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .date-cell .time {
      display: block;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* ── Detail Modal ── */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%; max-width: 680px; max-height: 85vh;
      overflow-y: auto; padding: 0;
    }

    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px; border-bottom: 1px solid var(--border);
    }

    .modal-header h3 { font-size: 1.1rem; font-weight: 600; }

    .modal-close {
      background: none; border: none; color: var(--text-muted);
      font-size: 1.4rem; cursor: pointer; padding: 4px;
    }
    .modal-close:hover { color: var(--text-primary); }

    .modal-body { padding: 24px; }

    .detail-row {
      display: flex; gap: 16px; margin-bottom: 16px;
    }

    .detail-label {
      font-size: 0.75rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
      min-width: 100px; padding-top: 2px;
    }

    .detail-value {
      font-size: 0.9rem; color: var(--text-primary);
      flex: 1;
    }

    .context-message {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 6px;
      font-size: 0.8rem;
    }

    .context-sender {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.72rem;
      margin-bottom: 2px;
    }

    .context-body { color: var(--text-secondary); }

    .modal-actions {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex; gap: 8px; justify-content: flex-end;
    }

    .notes-textarea {
      width: 100%; min-height: 60px; padding: 10px;
      background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary);
      font-size: 0.85rem; resize: vertical; font-family: inherit;
    }
    .notes-textarea:focus { outline: none; border-color: var(--accent); }

    /* ── Empty State ── */
    .empty-state {
      text-align: center; padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-state p { font-size: 0.85rem; max-width: 400px; margin: 0 auto; }

    /* ── Loading ── */
    .loading {
      text-align: center; padding: 40px;
      color: var(--text-muted); font-size: 0.9rem;
    }

    .spinner {
      width: 24px; height: 24px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .sidebar { width: 60px; }
      .sidebar .nav-label, .sidebar-header h1, .sidebar-header .version { display: none; }
      .main { margin-left: 60px; padding: 16px; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <h1>Command Center</h1>
      <div class="version">v3.0 — Approvals</div>
    </div>
    <div class="sidebar-nav">
      <a href="/" class="nav-item">
        <span class="nav-icon">&#x1f4ca;</span>
        <span class="nav-label">Dashboard</span>
      </a>
      <a href="/approvals" class="nav-item active">
        <span class="nav-icon">&#x2705;</span>
        <span class="nav-label">Approvals</span>
      </a>
      <a href="/#questions" class="nav-item">
        <span class="nav-icon">&#x2753;</span>
        <span class="nav-label">Questions</span>
      </a>
      <a href="/#mentions" class="nav-item">
        <span class="nav-icon">&#x1f4e2;</span>
        <span class="nav-label">Mentions</span>
      </a>
      <a href="/#dms" class="nav-item">
        <span class="nav-icon">&#x1f4ac;</span>
        <span class="nav-label">DMs</span>
      </a>
      <a href="/#tasks" class="nav-item">
        <span class="nav-icon">&#x1f4cb;</span>
        <span class="nav-label">Tasks</span>
      </a>
      <a href="/#settings" class="nav-item">
        <span class="nav-icon">&#x2699;&#xfe0f;</span>
        <span class="nav-label">Settings</span>
      </a>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main">
    <div class="page-header">
      <h2>&#x2705; Approval Tracker</h2>
      <div class="header-actions">
        <button class="btn" id="refreshBtn" onclick="loadData()">&#x1f504; Refresh</button>
        <a class="btn btn-accent" id="exportBtn" href="/api/approvals/export/csv" download>&#x1f4e5; Export CSV</a>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="statsRow">
      <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="statTotal">—</div></div>
      <div class="stat-card"><div class="stat-label">Approved</div><div class="stat-value green" id="statApproved">—</div></div>
      <div class="stat-card"><div class="stat-label">Rejected</div><div class="stat-value red" id="statRejected">—</div></div>
      <div class="stat-card"><div class="stat-label">Conditional</div><div class="stat-value yellow" id="statConditional">—</div></div>
      <div class="stat-card"><div class="stat-label">Pending Review</div><div class="stat-value purple" id="statPending">—</div></div>
      <div class="stat-card"><div class="stat-label">Unreviewed</div><div class="stat-value blue" id="statUnreviewed">—</div></div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <button class="filter-btn active" data-status="all" onclick="setFilter(this)">All</button>
      <button class="filter-btn" data-status="approved" onclick="setFilter(this)">Approved</button>
      <button class="filter-btn" data-status="rejected" onclick="setFilter(this)">Rejected</button>
      <button class="filter-btn" data-status="conditional" onclick="setFilter(this)">Conditional</button>
      <button class="filter-btn" data-status="pending_review" onclick="setFilter(this)">Pending Review</button>
      <span style="margin-left: auto;"></span>
      <input type="text" class="search-input" id="searchInput" placeholder="Search by name or group..." oninput="applySearch()">
    </div>

    <!-- Approval Table -->
    <div class="approvals-table-wrapper">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        Loading approvals...
      </div>
      <div id="emptyState" class="empty-state" style="display:none;">
        <div class="icon">&#x1f4cb;</div>
        <h3>No approvals found</h3>
        <p>When WhatsApp messages containing offer sheet approvals are detected by AI, they'll appear here.</p>
      </div>
      <table class="approvals-table" id="approvalsTable" style="display:none;">
        <thead>
          <tr>
            <th>Status</th>
            <th>Sender</th>
            <th>Group</th>
            <th>Summary</th>
            <th>Date</th>
            <th>Confidence</th>
            <th>Reviewed</th>
          </tr>
        </thead>
        <tbody id="approvalsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Approval Details</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <script>
    // ── Config ──
    const API_BASE = 'https://whatsapp-command-center-production.up.railway.app';
    let currentFilter = 'all';
    let allApprovals = [];
    let searchTerm = '';

    // Get auth token if exists
    function getHeaders() {
      const token = localStorage.getItem('cc_token');
      const h = { 'Content-Type': 'application/json' };
      if (token) h['Authorization'] = `Bearer ${token}`;
      return h;
    }

    // ── Load Data ──
    async function loadData() {
      try {
        const [approvalsRes, statsRes] = await Promise.all([
          fetch(`${API_BASE}/api/approvals`, { headers: getHeaders() }),
          fetch(`${API_BASE}/api/approvals/stats`, { headers: getHeaders() })
        ]);

        const approvalsData = await approvalsRes.json();
        const statsData = await statsRes.json();

        if (approvalsData.ok) {
          allApprovals = approvalsData.approvals;
          renderApprovals();
        }

        if (statsData.ok) {
          renderStats(statsData.stats);
        }
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('loadingState').innerHTML = '<p style="color: var(--danger);">Failed to load data. Check your connection.</p>';
      }
    }

    // ── Render Stats ──
    function renderStats(stats) {
      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statApproved').textContent = stats.approved;
      document.getElementById('statRejected').textContent = stats.rejected;
      document.getElementById('statConditional').textContent = stats.conditional;
      document.getElementById('statPending').textContent = stats.pendingReview;
      document.getElementById('statUnreviewed').textContent = stats.unreviewed;
    }

    // ── Render Approvals Table ──
    function renderApprovals() {
      const loading = document.getElementById('loadingState');
      const empty = document.getElementById('emptyState');
      const table = document.getElementById('approvalsTable');
      const tbody = document.getElementById('approvalsBody');

      // Filter
      let filtered = allApprovals;
      if (currentFilter !== 'all') {
        filtered = filtered.filter(a => a.status === currentFilter);
      }
      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = filtered.filter(a =>
          (a.sender || '').toLowerCase().includes(q) ||
          (a.chat_name || '').toLowerCase().includes(q) ||
          (a.ai_summary || '').toLowerCase().includes(q) ||
          (a.body || '').toLowerCase().includes(q)
        );
      }

      // Update CSV export link with current filter
      const exportUrl = currentFilter !== 'all'
        ? `/api/approvals/export/csv?status=${currentFilter}`
        : '/api/approvals/export/csv';
      document.getElementById('exportBtn').href = exportUrl;

      loading.style.display = 'none';

      if (filtered.length === 0) {
        empty.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      tbody.innerHTML = filtered.map(a => {
        const d = new Date(a.timestamp);
        const initials = (a.sender || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        const conf = (a.confidence || 0);
        const confPct = Math.round(conf * 100);
        const confColor = conf >= 0.8 ? 'var(--accent)' : conf >= 0.5 ? 'var(--warning)' : 'var(--danger)';

        return `<tr onclick="showDetail('${a.id}')">
          <td><span class="status-badge status-${a.status}"><span class="status-dot"></span>${a.status.replace('_', ' ')}</span></td>
          <td><div class="sender-cell"><div class="sender-avatar">${initials}</div>${escHtml(a.sender)}</div></td>
          <td style="color: var(--text-secondary); font-size: 0.82rem;">${escHtml(a.chat_name)}</td>
          <td><div class="msg-preview">${escHtml(a.ai_summary || a.body || '—')}</div></td>
          <td class="date-cell">${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}<span class="time">${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</span></td>
          <td>${confPct}%<div class="confidence-bar"><div class="confidence-fill" style="width:${confPct}%;background:${confColor}"></div></div></td>
          <td>${a.reviewed ? '<span class="reviewed-check">&#x2714;</span>' : '<span class="not-reviewed">&#x25cb;</span>'}</td>
        </tr>`;
      }).join('');
    }

    // ── Filters ──
    function setFilter(btn) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.status;
      renderApprovals();
    }

    function applySearch() {
      searchTerm = document.getElementById('searchInput').value;
      renderApprovals();
    }

    // ── Detail Modal ──
    async function showDetail(id) {
      const modal = document.getElementById('detailModal');
      const body = document.getElementById('modalBody');
      const actions = document.getElementById('modalActions');

      const a = allApprovals.find(x => x.id === id);
      if (!a) return;

      const d = new Date(a.timestamp);
      const contextMsgs = a.context_messages || [];

      body.innerHTML = `
        <div class="detail-row">
          <div class="detail-label">Status</div>
          <div class="detail-value"><span class="status-badge status-${a.status}"><span class="status-dot"></span>${a.status.replace('_', ' ')}</span></div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Sender</div>
          <div class="detail-value">${escHtml(a.sender)}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Group</div>
          <div class="detail-value">${escHtml(a.chat_name)}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Date</div>
          <div class="detail-value">${d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${d.toLocaleTimeString('en-US')}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">AI Summary</div>
          <div class="detail-value">${escHtml(a.ai_summary || '—')}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Message</div>
          <div class="detail-value" style="background: var(--bg-primary); padding: 12px; border-radius: 8px; font-size: 0.85rem;">${escHtml(a.body || '—')}</div>
        </div>
        ${a.offer_sheet_ref ? `<div class="detail-row">
          <div class="detail-label">Offer Ref</div>
          <div class="detail-value" style="font-size: 0.82rem; color: var(--text-secondary);">${escHtml(a.offer_sheet_ref)}</div>
        </div>` : ''}
        ${a.conditions ? `<div class="detail-row">
          <div class="detail-label">Conditions</div>
          <div class="detail-value" style="color: var(--warning);">${escHtml(a.conditions)}</div>
        </div>` : ''}
        <div class="detail-row">
          <div class="detail-label">Confidence</div>
          <div class="detail-value">${Math.round((a.confidence || 0) * 100)}%</div>
        </div>
        ${contextMsgs.length > 0 ? `
          <div class="detail-row" style="flex-direction: column; gap: 8px;">
            <div class="detail-label">Surrounding Messages</div>
            <div>${contextMsgs.map(m => `
              <div class="context-message">
                <div class="context-sender">${escHtml(m.sender)} <span style="color: var(--text-muted); font-weight: 400;">${new Date(m.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</span></div>
                <div class="context-body">${escHtml(m.body)}</div>
              </div>
            `).join('')}</div>
          </div>` : ''}
        <div class="detail-row" style="flex-direction: column; gap: 8px; margin-top: 12px;">
          <div class="detail-label">Notes</div>
          <textarea class="notes-textarea" id="notesInput" placeholder="Add notes about this approval...">${escHtml(a.notes || '')}</textarea>
        </div>
      `;

      actions.innerHTML = `
        ${!a.reviewed ? `<button class="btn btn-accent" onclick="reviewApproval('${a.id}')">&#x2714; Mark Reviewed</button>` : '<span style="color: var(--accent); font-size: 0.8rem;">&#x2714; Reviewed by ${escHtml(a.reviewed_by || "Admin")}</span>'}
        <button class="btn" onclick="saveNotes('${a.id}')">Save Notes</button>
        <button class="btn" onclick="closeModal()">Close</button>
      `;

      modal.classList.add('show');
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
    }

    async function reviewApproval(id) {
      try {
        await fetch(`${API_BASE}/api/approvals/${id}/review`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ reviewedBy: 'Admin' })
        });
        await loadData();
        closeModal();
      } catch (err) {
        console.error('Review failed:', err);
      }
    }

    async function saveNotes(id) {
      const notes = document.getElementById('notesInput').value;
      try {
        await fetch(`${API_BASE}/api/approvals/${id}`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify({ notes })
        });
        const idx = allApprovals.findIndex(a => a.id === id);
        if (idx >= 0) allApprovals[idx].notes = notes;
        closeModal();
      } catch (err) {
        console.error('Save notes failed:', err);
      }
    }

    // ── Helpers ──
    function escHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    // ── Keyboard shortcut ──
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Close modal on overlay click
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeModal();
    });

    // ── Init ──
    loadData();

    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
  </script>
</body>
</html>
